<%- include('../partials/header') %>

<div class="page-title-section">
    <h1 class="page-title">동호회 앨범</h1>
</div>

<div class="content-wrapper container">
    <% if (user) { %>
        <div style="text-align: right; margin-bottom: 2rem;">
            <button class="btn" onclick="toggleForm()">앨범 등록</button>
        </div>
        <div id="albumForm" class="form-container" style="max-width: none; margin-bottom: 3rem; display: none;">
            <h3>사진/동영상 업로드</h3>
            <form action="/album/upload" method="POST" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="caption">설명</label>
                    <input type="text" id="caption" name="caption">
                </div>
                <div class="form-group">
                    <label for="mediaFile">파일 선택</label>
                    <input type="file" id="mediaFile" name="mediaFile" accept="image/*,video/*" required>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn">업로드</button>
                </div>
            </form>
        </div>
    <% } %>

    <div class="grid-container">
        <% photos.forEach(photo => { %>
            <div class="grid-item" onclick="openLightbox('/uploads/album/<%= photo.filePath %>', '<%= photo.fileType %>')">
                <% if (photo.fileType === 'image') { %>
                    <img src="/uploads/album/<%= photo.filePath %>" alt="<%= photo.caption %>">
                <% } else { %>
                    <video src="/uploads/album/<%= photo.filePath %>"></video>
                <% } %>
                <h3><%= photo.caption %></h3>
                <p>Uploader: <%= photo.uploader_nickname %></p>
                <% if (user && (user.isAdmin || user.id === photo.uploader_id)) { %>
                    <form action="/album/delete/<%= photo.id %>" method="POST" style="margin-top: 1rem;">
                        <button type="submit" class="btn btn-delete">삭제</button>
                    </form>
                <% } %>
            </div>
        <% }) %>
    </div>
</div>

<!-- Lightbox HTML (페이지 하단에 추가) -->
<div id="lightbox" class="lightbox-overlay" onclick="closeLightbox()">
    <span class="lightbox-close">&times;</span>
    <div class="lightbox-content">
        <img id="lightbox-image" class="lightbox-media" src="" alt="Lightbox Image">
        <video id="lightbox-video" class="lightbox-media" src="" controls></video>
    </div>
</div>

<script>
    function toggleForm() {
        const form = document.getElementById('albumForm');
        if (form.style.display === 'none') {
            form.style.display = 'block';
        } else {
            form.style.display = 'none';
        }
    }

    // Lightbox JavaScript
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image');
    const lightboxVideo = document.getElementById('lightbox-video');

    function openLightbox(filePath, fileType) {
        if (fileType === 'image') {
            lightboxImage.src = filePath;
            lightboxImage.style.display = 'block';
            lightboxVideo.style.display = 'none';
        } else {
            lightboxVideo.src = filePath;
            lightboxVideo.style.display = 'block';
            lightboxImage.style.display = 'none';
        }
        lightbox.style.display = 'flex';
    }

    function closeLightbox() {
        lightbox.style.display = 'none';
        lightboxImage.src = '';
        lightboxVideo.src = '';
        lightboxVideo.pause(); // 비디오 재생 중지
    }

    // 이벤트 버블링 방지
    document.querySelector('.lightbox-content').addEventListener('click', function(event) {
        event.stopPropagation();
    });
</script>

<%- include('../partials/footer') %>